name: Build and Test C# Client and Arduino Server

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

jobs:
  build-csharp:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check .NET SDK
        run: dotnet --list-sdks

      - name: Restore dependencies
        run: dotnet restore ./client/client.csproj

      - name: Build C# project
        run: dotnet build --configuration Debug ./client/client.csproj

      - name: Run tests
        run: dotnet test --no-build --verbosity normal --logger "console;verbosity=detailed" > test_results.txt

      - name: Publish test results
        uses: actions/upload-artifact@v3
        with:
          name: Test-Results
          path: test_results.txt

      - name: Publish C# binary
        uses: actions/upload-artifact@v3
        with:
          name: CSharp-Binary
          path: ./client/bin/Release/

  build-arduino:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Arduino CLI
        run: |
          wget https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
          tar -xvf arduino-cli_latest_Linux_64bit.tar.gz
          sudo mv arduino-cli /usr/local/bin/
          arduino-cli config init

      - name: Install Arduino Uno core
        run: arduino-cli core install arduino:avr

      - name: Compile Arduino project
        run: arduino-cli compile --fqbn arduino:avr:uno ./server/server.ino

      - name: Upload Arduino binary
        uses: actions/upload-artifact@v3
        with:
          name: Arduino-Binary
          path: ./server/build/

  post:
    runs-on: ubuntu-latest
    needs: [build-csharp, build-arduino]
    steps:
      - name: Create combined artifacts
        run: |
          mkdir -p ci/artifacts
          cp -r ./client/bin/Release/* ci/artifacts/
          cp -r ./server/build/* ci/artifacts/

      - name: Upload combined binaries
        uses: actions/upload-artifact@v3
        with:
          name: Combined-Binaries
          path: ./ci/artifacts
