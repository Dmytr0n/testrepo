name: Build and Test C# Client and Arduino Server

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

jobs:
  build-arduino:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Arduino CLI
        run: |
          wget https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
          tar -xvf arduino-cli_latest_Linux_64bit.tar.gz
          sudo mv arduino-cli /usr/local/bin/
          arduino-cli config init

      - name: Install Arduino Uno core
        run: arduino-cli core install arduino:avr

      - name: Compile Arduino project
        run: arduino-cli compile --fqbn arduino:avr:uno ./server/server.ino

      - name: Upload Arduino binary
        uses: actions/upload-artifact@v3
        with:
          name: Arduino-Binary
          path: ./server/build/

  post:
    runs-on: ubuntu-latest
    needs: [build-arduino]
    steps:
      - name: Create combined artifacts
        run: |
          mkdir -p ci/artifacts
          cp -r ./server/build/* ci/artifacts/

      - name: Upload combined binaries
        uses: actions/upload-artifact@v3
        with:
          name: Combined-Binaries
          path: ./ci/artifacts
